app.factory("httpRequest",["$http","$q","$log",function($http,$q,$log){return{Request:function(requestType,api,requestData,header,service,isShowLoading,isCache){var url,d=$q.defer();if(url=service?api:serviceUrl+api,isShowLoading&&showLoading(),$http.defaults.headers.common=header?header:{"content-type":"application/json"},"get"==requestType||"GET"==requestType||"DELETE"==requestType){var phpApi="http://m.xiaoniubang.com/api/post.php",data={url:url,data:{},method:requestType};$http({method:"POST",url:phpApi,data:angular.toJson(data),cache:isCache}).success(function(data){hideLoading(),d.resolve(1==data.status?data.data:data.msg)}).error(function(data,status,headers){hideLoading(),$log.error("Error: ",headers),d.reject(data)})}else{var phpApi="http://m.xiaoniubang.com/api/post.php",data={url:url,data:requestData,method:requestType};$http({method:"POST",url:phpApi,data:angular.toJson(data),cache:isCache}).success(function(data){hideLoading(),d.resolve(data)}).error(function(data,status,headers){hideLoading(),$log.error("Error: ",headers),d.reject(data)})}return d.promise},Get:function(api,isShowLoading,header,requestData,isCache,service){isCache=void 0==isCache?!0:isCache;var r=requestData?requestData:"";return this.Request("GET",api,r,header,service,isShowLoading,isCache)},POST:function(api,requestData,header,isShowLoading){return this.Request("POST",api,requestData,header,!1,isShowLoading)},PUT:function(api,requestData,header,isShowLoading){return this.Request("PUT",api,requestData,header,!1,isShowLoading)},DELETE:function(api,requestData,header,isShowLoading){return this.Request("DELETE",api,"",header,!1,isShowLoading)},APIPOST:function(api,requestData,header,isShowLoading){return this.Request("POST",api,requestData,header,javaServiceUrl,isShowLoading)}}}]),app.factory("anchorScroll",function(){function toView(element,top,height){var winHeight=$(window).height();element=$(element);var scrollTo=element.offset().top-height;scrollTo>0&&1>=scrollTo||$(".scrollable-content").animate({scrollTop:top?scrollTo:element.offset().top+element.outerHeight()+height-winHeight},{duration:10,easing:"linear",complete:function(){if(!inView(element)){var offset=element.offset().top-height,adj=scrollTo>0?scrollTo:0;$(".scrollable-content").scrollTop(offset+adj)}}})}function inView(element){function isInView(middle){return middle>viewTop&&viewBottom>middle}element=$(element);var win=$(window),winHeight=win.height(),eleTop=element.offset().top,eleHeight=element.outerHeight(),viewTop=win.scrollTop(),viewBottom=viewTop+winHeight;return isInView(eleTop+(eleHeight>winHeight?winHeight:eleHeight)/2)?!0:eleHeight>winHeight?isInView(eleTop+eleHeight-winHeight/2):!1}return{toView:toView,inView:inView}}),app.factory("dataStringify",[function(){return function(api,requestData,isSet){var raw=function(args){args.t=(new Date).getTime(),args.device="5";var keys=Object.keys(args);keys=keys.sort();var newArgs={};keys.forEach(function(key){newArgs[key]=args[key]});var string="";for(var k in newArgs)string+="&"+k+"="+newArgs[k];return string=string.substr(1)},sign=raw(requestData);return requestData?isSet?api+"?m5="+$.md5("/api"+api+"?"+sign+"_2014hofysoft_web"):api+"?"+sign+"&m5="+$.md5("/api"+api+"?"+sign+"_2014hofysoft_web"):""}}]),app.factory("signSha1",[function(){return function(requestData){return requestData?$.sha1(requestData):""}}]),app.controller("teachersController",function($rootScope,dataStringify,$scope,$location,signSha1,$routeParams,httpRequest){function initMap(point){point=new BMap.Point(point.lng-.004,point.lat+.00199);var gc=new BMap.Geocoder;gc.getLocation(point,function(rs){var addComp=rs.addressComponents;$rootScope.currentCity=addComp,$scope.isGetLocation=!0,$scope.$apply($scope.isGetLocation)});var data={lng:point.lng,user_id:$rootScope.user?$rootScope.user.id||0:0,lat:point.lat};httpRequest.Get(dataStringify("/user/cleanerLBS",data),{}).then(function(result){if(result&&result.status==statusMsg.Success){$scope.cleaners=result.cleaners,$scope.isGetLocation=!0,$scope.$apply($scope.isGetLocation);for(var c in $scope.cleaners){var distance=bm.getDistance(point,new BMap.Point($scope.cleaners[c].lng,$scope.cleaners[c].lat));$scope.cleaners[c].distance=(distance/1e3).toFixed(2)}$scope.cleaners.sort(function(a,b){return a.distance-b.distance}),$scope.$apply($scope.cleaners)}else alertWarning(result.message)})}setDocumentTitle(),$rootScope.leftbar="fa-bars",$(".app-body").css("padding-top","50px"),$rootScope.user=getToken(),$rootScope.rootAct=$rootScope.user,$scope.$apply($rootScope.user),$scope.$apply($rootScope.rootAct);var rcRoute=getRechargeRoute(),o=getOrder();if(rcRoute&&o&&(1==rcRoute.flag||11==rcRoute.flag)){var cId=rcRoute.cleanerId;$location.path("/order/"+cId)}if(rcRoute&&2==rcRoute.flag){var cId=rcRoute.cleanerId;$location.path("/payment/"+cId+"/n")}var bm=new BMap.Map("allmap"),pnt=(getMobileType(),new BMap.Point($rootScope.user.lng,$rootScope.user.lat));BMap.Convertor.translate(pnt,0,initMap),$rootScope.currentCity&&($scope.isGetLocation=!0);$scope.goMap=function(){$location.path("/")},rcRoute&&o&&1==rcRoute.flag||removeCleaner(),$scope.goTeacher=function(index){setCleaner($scope.cleaners[index]),$location.path("/teacher")}}),app.controller("teacherController",function($rootScope,dataStringify,$scope,$location,signSha1,$routeParams,httpRequest){setDocumentTitle(),$rootScope.leftbar="fa-angle-left",$(".app-body").css("padding-top","50px"),$scope.cleaner=getCleaner(),$scope.cleaner||alertExt("请先选择美车师",function(){$location.path("/"),$scope.$apply($location)}),$scope.order=function(id){removeOrder(),$location.path("/order/"+id)};var data={direction:1,cleaner_id:$scope.cleaner?$scope.cleaner.id:148,user_id:$rootScope.user.id};httpRequest.Get(dataStringify("/evaluations/get",data),!0,{}).then(function(result){result&&result.status==statusMsg.Success&&($scope.evls=result.evaluations,$scope.totalCount=result.total_count)})}),app.controller("orderController",function($rootScope,dataStringify,$scope,$location,signSha1,$routeParams,httpRequest){function initArea(){$("#pAddress").mobiscroll().treelist({theme:"android-ics light",display:"bottom",mode:"scroller",labels:["日期","时间段"],setText:"确认",cancelText:"取消",width:"90",insertTo:"#serviceTime",onSelect:function(){var selectObj=$("#pAddress").mobiscroll("getInst"),arrSelectObjVal=selectObj.val.split(". "),curDate=new Date,seletedDate=new Date(curDate.getTime()+864e5*parseInt(arrSelectObjVal[0]));$scope.datetime=seletedDate.Format("yyyy-MM-dd")+" "+arrSelectObjVal[1],$scope.$apply($scope.datetime);var order=getOrder();order=order||{},order.datetime=$scope.datetime,setOrder(order)}})}function initMap(point){point=new BMap.Point(point.lng-.004,point.lat+.00199);var gc=new BMap.Geocoder;gc.getLocation(point,function(rs){var addComp=rs.addressComponents;$rootScope.currentCity=addComp;var localCity=new BMap.LocalCity;localCity.get(function(e){$scope.city_code=e.code,$rootScope.currentCity&&$rootScope.currentCity.city&&$rootScope.currentCity.city!=e.name&&($scope.city_code=224),goToOrderDetail()}),order&&order.address?($scope.address=order.address,order.lng=order.lng||point.lng,order.lat=order.lat||point.lat,setOrder(order)):($scope.address=rs.address,order=order||{},order.lng=point.lng,order.lat=point.lat,order.address=order.address||rs.address,setOrder(order)),$scope.$apply($scope.address)})}function goToOrderDetail(){var rcRoute=getRechargeRoute();if(rcRoute&&(1==rcRoute.flag||11==rcRoute.flag)){setRechargeRoute(null);var o=getOrder()||{};if(1!=o.ex7)return;var data={user_id:o.ex1,need_invoice:"0",invoice_title:"",mobile:o.mobile,address:o.address,lat:o.lat,lng:o.lng,city_code:o.ex2,cleaner_id:o.ex3,car_no:o.car.car_no,car_type:o.car.type,car_id:o.car.id,brand:o.car.brand,mode:o.car.mode,color:o.car.color,services:o.ex4,reserve_time:o.datetime,coupon_serial_no:o.ex5,comment:o.ex6};httpRequest.POST(dataStringify("/order/add_v3",data,!0),data,{"Content-Type":"application/json"},!0).then(function(result){if(1==result.status){if(result.data.status==statusMsg.Success||"OK"==result.data.status){var msg="亲，您的订单已经成功发送给指定的美车师，他在接单后会第一时间联系您，若20分钟后未联系您，订单将失效，请耐心等待，不要重复下单！",arrButton=["确定"];openDialog(msg,"",arrButton,0,function(r){r||($location.path("/payment/"+result.data.order.id),$rootScope.redirectPath="/",$scope.$apply($location))})}}else if("183011"==result.data.status){var arrButton=["取消","前往充值"];openDialog(result.data.message,"",arrButton,null,function(r){if(r){var od=getOrder()||{};od.ex1=data.user_id,od.ex2=data.city_code,od.ex3=data.cleaner_id,od.ex4=data.services,od.ex5=data.coupon_serial_no,od.ex6=data.comment,setOrder(od),setRechargeRoute({flag:1,cleanerId:$scope.cleanerId||getCleaner().id}),$location.path("/recharge/"+result.data.balance_margin),$scope.$apply($location)}})}else alertWarning(result.data.message)})}}setDocumentTitle("预约洗车"),$rootScope.leftbar="fa-angle-left",$scope.cleanerId=$routeParams.cleanerId||0,$(".app-body").css("padding-top","0"),$rootScope.pageTitle="预约洗车",$rootScope.couponPage=!1,$scope.selectCoupon=function(type,addType){$rootScope.couponPage=!0,$rootScope.isNoBack=!0,$rootScope.pageTitle="优惠券",$scope.couponPageType=type,$scope.addCouponType=1==addType?addType:0},$scope.summary={total_amount:0,pay_off:0,final_amount:0},$scope.availableCoupons=[],$scope.getDiscount=function(data,callback){httpRequest.Get(dataStringify("/order/discount/details",data),!0,{}).then(function(result){result&&result.status==statusMsg.Success?($scope.summary.total_amount=result.total_amount,$scope.summary.pay_off=result.pay_off,$scope.summary.final_amount=result.final_amount,callback&&callback($scope.summary)):($scope.summary.total_amount=$scope.totalAmout,$scope.summary.pay_off=0,$scope.summary.final_amount=$scope.totalAmout)})},$scope.setCoupon=function(coupon){if(2==coupon.provider_id){var arrButton=["取消","前往下载"];return void openDialog("该优惠券只能在小牛帮APP内使用，请下载小牛帮APP","",arrButton,null,function(r){r&&(window.location.href="http://d.xiaoniubang.com/")})}$scope.isSetCoupon=!0,$scope.isUseCoupon=!0,$rootScope.couponPage=!1,$rootScope.isNoBack=!1,$rootScope.pageTitle="预约洗车";var sevs=[];if($scope.content){for(var o=$scope.content||[],i=0;i<o.length;i++){var s={};s.service_id=o[i].id,s.count=1,sevs.push(s)}var data={user_id:$rootScope.user.id,services:angular.toJson(sevs),city_code:$scope.city_code,car_type:$scope.car.type,coupon_serial_no:coupon.serial_no};$scope.getDiscount(data)}$scope.currentCoupon=coupon},$scope.getAvailableCoupons=function(data,callback){httpRequest.Get(dataStringify("/coupon/available",data),!0,{}).then(function(result){result&&result.status==statusMsg.Success&&($scope.availableCoupons=result.coupons,$scope.availableCoupons00=[{service_id:"5",name:"内饰基础清洁",list:[{serial_no:"544A08878E1ED16F",expire_date:"2015-12-16",create_time:"2014-12-16 12:41:17",creator:"1",last_update_time:"2014-12-16 12:47:06",update_by:"145",status:"0",order_id:"498",amount:"4",requirement_id:"",service_id:"5",name:"代金券",coupon_type:"2",small_car_price:"",big_car_price:"",memo:"",small_reference_price:"可享受9.0折优惠",big_reference_price:"",provider_id:"1",user_id:"1",category:"内饰基础清洁"}]}],callback&&callback($scope.availableCoupons))})},$scope.addCoupon=function(data,callback){httpRequest.POST(dataStringify("/coupon/add",data,!0),data,{"Content-Type":"application/json"},!0).then(function(result){1==result.status?result.data.status==statusMsg.Success&&alertExt("添加优惠券成功！",function(){callback&&callback(result.data.coupon)}):alertWarning(result.data.message)})},$scope.addNewCoupon=function(){if(!$scope.couponNo)return alertWarning("请输入优惠券密码"),!1;var data={user_id:$rootScope.user.id,coupon_serial_no:$scope.couponNo},callback=function(cp){if($scope.addCouponType){$scope.couponPageType=1;for(var i=0;i<$scope.content.length;i++){var s={};s.service_id=$scope.content[i].id,s.count=1,sevs.push(s)}var data={user_id:$rootScope.user.id,services:angular.toJson(sevs)};$scope.getAvailableCoupons(data)}else $scope.currentCoupon=cp,$scope.isSetCoupon=!0,$rootScope.couponPage=!1,$rootScope.isNoBack=!1,$rootScope.pageTitle="预约洗车"};$scope.addCoupon(data,callback)},$scope.goToAddress=function(){$location.path("/address")},$scope.goToServices=function(){var order=getOrder()||{};return order.car?void $location.path("/services"):void alertWarning("请先选择您要服务的车辆")},$scope.goToDateTime=function(){initArea(),$("#pAddress").mobiscroll("show")},$scope.goToCar=function(){$location.path("/myCars")},httpRequest.Get(dataStringify("/service_time/get",{user_id:$rootScope.user.id}),!1,{}).then(function(result){if(result&&result.status==statusMsg.Success){for(var service_time=result.service_time,fromHour=parseInt(service_time.from_hour),toHour=parseInt(service_time.to_hour),regionHour=toHour-fromHour,continueDays=parseInt(service_time.continue_days),curHour=(new Date).getHours(),curMinute=(new Date).getMinutes(),todayUl='<li data-val="0.">今天<ul>',isToday=!1,i=0;regionHour>i;i++)fromHour+i>curHour&&(isToday=!0,todayUl=todayUl+'<li data-val="'+(fromHour+i)+":00 ~ "+(fromHour+i+1)+':00">'+(fromHour+i)+":00 ~ "+(fromHour+i+1)+":00</li>"),fromHour+i==curHour&&30>=curMinute&&(isToday=!0,todayUl=todayUl+'<li data-val="'+(fromHour+i)+":00 ~ "+(fromHour+i+1)+':00">'+(fromHour+i)+":00 ~ "+(fromHour+i+1)+":00</li>");todayUl+="</ul></li>",isToday||(todayUl=""),tomorrowUl='<li data-val="1.">明天<ul>',aTomorrowUl='<li data-val="2.">后天<ul>';for(var i=0;regionHour>i;i++)tomorrowUl=tomorrowUl+'<li data-val="'+(fromHour+i)+":00 ~ "+(fromHour+i+1)+':00">'+(fromHour+i)+":00 ~ "+(fromHour+i+1)+":00</li>",aTomorrowUl=aTomorrowUl+'<li data-val="'+(fromHour+i)+":00 ~ "+(fromHour+i+1)+':00">'+(fromHour+i)+":00 ~ "+(fromHour+i+1)+":00</li>";2==continueDays&&(tomorrowUl+="</ul></li>",aTomorrowUl=""),continueDays>=3&&(tomorrowUl+="</ul></li>",aTomorrowUl+="</ul></li>"),$("#pAddress").html(todayUl+tomorrowUl+aTomorrowUl)}else alertWarning(result.message)});var order=getOrder();if(order||(setOrder({mobile:$rootScope.user.mobile||""}),order=getOrder()),order){$scope.mobile=order.mobile||"",$scope.address=order.address||"",$scope.car=order.car||"",$scope.content=order.content||"",$scope.totalAmout=order.totalAmout||"",$scope.datetime=order.datetime||"";var sevs=[];if(order.content){for(var o=order||[],i=0;i<o.content.length;i++){var s={};s.service_id=o.content[i].id,s.count=1,sevs.push(s)}var data={user_id:$rootScope.user.id,services:angular.toJson(sevs)};$scope.getAvailableCoupons(data);var data={user_id:$rootScope.user.id,services:angular.toJson(sevs),city_code:$scope.city_code,car_type:$scope.car.type,coupon_serial_no:""};$scope.getDiscount(data)}}else $scope.mobile="",$scope.address="",$scope.car="",$scope.content="",$scope.totalAmout=0,$scope.datetime="",$scope.isUseCoupon=!0;var data={user_id:$rootScope.user.id,direction:1};httpRequest.Get(dataStringify("/cars/get",data),!1,{}).then(function(result){if(result&&result.status==statusMsg.Success){var cars=result.cars;cars&&cars.length>0&&(order.car&&""!=order.car||(order.car=cars[0],setOrder(order),$scope.car=order.car))}}),$scope.isUseCoupon=!0,$scope.toggleCoupon=function(){$scope.isUseCoupon=!$scope.isUseCoupon;var sevs=[];if($scope.content){for(var o=$scope.content||[],i=0;i<o.length;i++){var s={};s.service_id=o[i].id,s.count=1,sevs.push(s)}var data={user_id:$rootScope.user.id,services:angular.toJson(sevs),city_code:$scope.city_code,car_type:$scope.car.type};$scope.isUseCoupon?(data.coupon_serial_no=$scope.availableCoupons[0].list[0].serial_no,$scope.getDiscount(data)):(data.coupon_serial_no="",$scope.getDiscount(data,function(s){$scope.summary.total_amount=s.total_amount,$scope.summary.pay_off=0,$scope.summary.final_amount=s.total_amount,$scope.$apply($scope.summary)}))}},$scope.saveOrder=function(){var order=getOrder();order?(order.mobile=$scope.mobile,order.comment=$scope.comment):(order={},order.mobile=$scope.mobile,order.comment=$scope.comment),setOrder(order)},$("#allmap").height($(".home-page").height()-$("#title").height());var pnt=(new BMap.Map("allmap"),getMobileType(),new BMap.Point($rootScope.user.lng,$rootScope.user.lat));BMap.Convertor.translate(pnt,0,initMap),$scope.city_code=224;var checkOrder=function(o){return o.mobile?o.car?o.address?o.datetime?o.content?!0:(alertWarning("请选择服务内容"),!1):(alertWarning("请选择预约时间"),!1):(alertWarning("请选择地址"),!1):(alertWarning("请选择车辆"),!1):(alertWarning("请输入手机号码"),!1)};$scope.order=function(){var o=getOrder()||{};if(checkOrder(o)){var sevs=[];o.content=o.content||[];for(var i=0;i<o.content.length;i++){var s={};s.service_id=o.content[i].id,s.count=1,sevs.push(s)}var data={user_id:$rootScope.user.id,need_invoice:"0",invoice_title:"",mobile:o.mobile,address:o.address,lat:o.lat,lng:o.lng,city_code:$scope.city_code,cleaner_id:$scope.cleanerId||getCleaner().id,car_no:o.car.car_no,car_type:o.car.type,car_id:o.car.id,brand:o.car.brand,mode:o.car.mode,color:o.car.color,services:angular.toJson(sevs),reserve_time:o.datetime,coupon_serial_no:$scope.isSetCoupon&&$scope.isUseCoupon?$scope.currentCoupon.serial_no:"",comment:o.comment||$scope.comment||""};if(data.coupon_serial_no&&$scope.currentCoupon&&4==$scope.currentCoupon.provider_id){var od=getOrder()||{};return od.ex1=data.user_id,od.ex2=data.city_code,od.ex3=data.cleaner_id,od.ex4=data.services,od.ex5=data.coupon_serial_no,od.ex6=data.comment,od.ex7=0,setOrder(od),setRechargeRoute({flag:11,cleanerId:$scope.cleanerId||getCleaner().id}),void(window.location.href="http://m.xiaoniubang.com/ebank/mpi/proccess/TransProcess.php?user_id="+data.user_id+"&orderNumber="+(new Date).getTime()+"&orderAmount="+$scope.summary.final_amount||$scope.summary.amount+"&rechargeType=7&productId=0")}httpRequest.POST(dataStringify("/order/add_v3",data,!0),data,{"Content-Type":"application/json"},!0).then(function(result){if(1==result.status){if(result.data.status==statusMsg.Success){var msg="亲，您的订单已经成功发送给指定的美车师，他在接单后会第一时间联系您，若20分钟后未联系您，订单将失效，请耐心等待，不要重复下单！",arrButton=["确定"];openDialog(msg,"",arrButton,0,function(r){r||($location.path("/payment/"+result.data.order.id),$rootScope.redirectPath="/",$scope.$apply($location))})}}else if("183011"==result.data.status){var arrButton=["取消","前往充值"];openDialog(result.data.message,"",arrButton,null,function(r){if(r){var od=getOrder()||{};od.ex1=data.user_id,od.ex2=data.city_code,od.ex3=data.cleaner_id,od.ex4=data.services,od.ex5=data.coupon_serial_no,od.ex6=data.comment,setOrder(od),setRechargeRoute({flag:1,cleanerId:$scope.cleanerId||getCleaner().id}),$location.path("/recharge/"+result.data.balance_margin),$scope.$apply($location)}})}else alertWarning(result.data.message)})}}}),app.controller("addressController",function($rootScope,dataStringify,$scope,$location){function initMap(point){point=new BMap.Point(point.lng-.004,point.lat+.00199),myPoint=point;var o=getOrder()||{};if(o.isSelect){var p=new BMap.Point(o.lng,o.lat);marker=new BMap.Marker(p),bm.addOverlay(marker);var label=new BMap.Label("洗车地点",{offset:new BMap.Size(20,-10)});marker.setLabel(label),myMarker=new BMap.Marker(myPoint),bm.addOverlay(myMarker);var label=new BMap.Label("我的位置",{offset:new BMap.Size(20,-10)});myMarker.setLabel(label),$scope.address1=o.address1,$scope.$apply($scope.address1),$scope.address2=o.address2,$scope.$apply($scope.address2)}else{marker=new BMap.Marker(myPoint),bm.addOverlay(marker);var label=new BMap.Label("我的位置",{offset:new BMap.Size(20,-10)});marker.setLabel(label)}bm.setCenter(point),marker.enableDragging(),bm.addEventListener("click",showInfo);var gc=new BMap.Geocoder;gc.getLocation(point,function(rs){rs.addressComponents;o.isSelect||($scope.address1=rs.address,$scope.$apply($scope.address1)),$scope.point=point})}setDocumentTitle(),$rootScope.leftbar="fa-angle-left",$(".app-body").css("padding-top","50px"),$scope.address1="",$scope.address2="",$scope.point={},$(".app-body").css("padding-top","0"),$("#allmap").height($(".home-page").height()-$("#title").height()+15);var bm=new BMap.Map("allmap"),marker=null,myMarker=null,myPoint=null,isSelect=!1,navigationControl=new BMap.NavigationControl({anchor:BMAP_ANCHOR_BOTTOM_RIGHT,type:BMAP_NAVIGATION_CONTROL_LARGE,enableGeolocation:!0});bm.addControl(navigationControl);var geolocationControl=new BMap.GeolocationControl;geolocationControl.addEventListener("locationSuccess",function(e){var address="";address+=e.addressComponent.province,address+=e.addressComponent.city,address+=e.addressComponent.district,address+=e.addressComponent.street,address+=e.addressComponent.streetNumber}),geolocationControl.addEventListener("locationError",function(e){alert(e.message)}),bm.addControl(geolocationControl);var pnt=(getMobileType(),new BMap.Point($rootScope.user.lng,$rootScope.user.lat));bm.centerAndZoom(pnt,15),setTimeout(function(){BMap.Convertor.translate(pnt,0,initMap)},0);var showInfo=function(e){var gc=new BMap.Geocoder;gc.getLocation(e.point,function(rs){rs.addressComponents;$scope.address1=rs.address,$scope.$apply($scope.address1),bm.removeOverlay(marker),marker=new BMap.Marker(e.point),bm.addOverlay(marker);var label=new BMap.Label("洗车地点",{offset:new BMap.Size(20,-10)});marker.setLabel(label),myMarker=new BMap.Marker(myPoint),bm.addOverlay(myMarker);var label=new BMap.Label("我的位置",{offset:new BMap.Size(20,-10)});myMarker.setLabel(label),$scope.address2="",$scope.$apply($scope.address2),isSelect=!0,$scope.point=e.point})};$scope.save=function(){$scope.address=$scope.address1+$scope.address2;var order=getOrder();order?(order.address=$scope.address,order.address1=$scope.address1,order.address2=$scope.address2,order.lng=$scope.point.lng,order.lat=$scope.point.lat,order.isSelect=isSelect):(order={},order.address=$scope.address,order.address1=$scope.address1,order.address2=$scope.address2,order.lng=$scope.point.lng,order.lat=$scope.point.lat,order.isSelect=isSelect),setOrder(order),$location.path("/order/"+getCleaner().id)}}),app.controller("paymentController",function($rootScope,$scope,dataStringify,$location,signSha1,$routeParams,httpRequest){if(setDocumentTitle(),$rootScope.leftbar="fa-angle-left",$(".app-body").css("padding-top","0"),$scope.orderId=$routeParams.orderId||-1,$scope.isService=$routeParams.isService||"n","y"==$scope.isService?(setDocumentTitle("服务列表"),$scope.isShowServiceList=!0,$rootScope.pageTitle="服务列表"):(setDocumentTitle("当前订单"),$scope.isShowServiceList=!1,$rootScope.pageTitle="当前订单"),$scope.addService=function(){$location.path("/payment/"+$scope.orderId+"/y")},"y"!=$scope.isService){var rcRoute=getRechargeRoute();if(rcRoute&&2==rcRoute.flag){var data=rcRoute.extData;setRechargeRoute(null),httpRequest.POST(dataStringify("/services/appendOrUpgrade_v2",data,!0),data,{"Content-Type":"application/json"},!1).then(function(result){if(1==result.status){if(result.data.status==statusMsg.Success){var data={user_id:$rootScope.user.id,order_id:$scope.orderId};httpRequest.Get(dataStringify("/order/details/get",data),!0,{}).then(function(result){result&&result.status==statusMsg.Success&&($scope.order=result.order,httpRequest.Get(dataStringify("/user/details/get_v2",{user_id:result.order.cleaner_id}),!0,{}).then(function(result){result&&result.status==statusMsg.Success&&($scope.cleaner=result.user)}))})}}else if("183011"==result.data.status){var arrButton=["取消","前往充值"];openDialog(result.data.message,"",arrButton,null,function(r){r&&(setRechargeRoute({flag:2,cleanerId:$scope.orderId,extData:data}),$location.path("/recharge/"+result.data.balance_margin),$scope.$apply($location))})}else alertWarning(result.data.message)})}else{var data={user_id:$rootScope.user.id,order_id:$scope.orderId};httpRequest.Get(dataStringify("/order/details/get",data),!0,{}).then(function(result){result&&result.status==statusMsg.Success&&($scope.order=result.order,httpRequest.Get(dataStringify("/user/details/get_v2",{user_id:result.order.cleaner_id}),!0,{}).then(function(result){result&&result.status==statusMsg.Success&&($scope.cleaner=result.user)}))})}}if("y"==$scope.isService){$scope.selectedService=[];var data={user_id:$rootScope.user.id,order_id:$scope.orderId};httpRequest.Get(dataStringify("/services/filter_v2",data),!0,{}).then(function(result){result&&result.status==statusMsg.Success&&($scope.services=result.services,$scope.getTotalAmout())}),$(".scrollable-content").delegate(".col-xs-2.choice-option","click",function(){var $fa=$(this).find(".fa"),isMust=$fa.hasClass("must"),isRadio=$(this).parent().parent().parent().find(".service-title-radio").length,isChecked=$fa.hasClass("fa-check-circle");if(isMust)return void alertWarning("该项服务为必须项目");if(isRadio){var checkedOption=$(this).parent().parent().parent().find(".fa-check-circle");checkedOption.removeClass("fa-check-circle"),checkedOption.addClass("fa-circle-thin"),checkedOption.parent().parent().removeClass("main-text2")}isChecked?($fa.addClass("fa-circle-thin"),$fa.removeClass("fa-check-circle"),$fa.parent().parent().removeClass("main-text2")):($fa.addClass("fa-check-circle"),$fa.removeClass("fa-circle-thin"),$fa.parent().parent().addClass("main-text2")),$scope.selectedService=[],$(".col-xs-2.choice-option").each(function(){var fa=$(this).find(".fa"),svs=$(this).attr("data").split("-"),isCk=fa.hasClass("fa-check-circle");isCk&&$scope.selectedService.push($scope.services[svs[0]].children[svs[1]])}),$scope.getTotalAmout()}),$scope.getTotalAmout=function(){$scope.totalAmout=0;for(var i=0;i<$scope.selectedService.length;i++)$scope.totalAmout=$scope.totalAmout+parseInt($scope.selectedService[i].price);$scope.$apply($scope.totalAmout)},$scope.appendService=function(){for(var sArr=[],i=0;i<$scope.selectedService.length;i++){var s={};s.service_id=$scope.selectedService[i].id,s.count=1,s.append_type=$scope.selectedService[i].append_type,s.parent_id=$scope.selectedService[i].parent_id,sArr.push(s)}var data={user_id:$rootScope.user.id,order_id:$scope.orderId,services:angular.toJson(sArr)};httpRequest.POST(dataStringify("/services/appendOrUpgrade_v2",data,!0),data,{"Content-Type":"application/json"},!0).then(function(result){if(1==result.status)result.data.status==statusMsg.Success&&alertExt("追加服务成功！",function(){history.back()});else if("183011"==result.data.status){var arrButton=["取消","前往充值"];openDialog(result.data.message,"",arrButton,null,function(r){r&&(setRechargeRoute({flag:2,cleanerId:$scope.orderId,extData:data}),$location.path("/recharge/"+result.data.balance_margin),$scope.$apply($location))})}else alertWarning(result.data.message)})}}$scope.goToServiceDetail=function(url,name){$location.path("/service").search({url:url,name:name})},$scope.updateOrder=function(status){var data={user_id:$rootScope.user.id,order_id:$scope.orderId,status:status};if(8==status&&httpRequest.PUT(dataStringify("/order/status/update_v2",data,!0),data,{"Content-Type":"application/json"},!0).then(function(result){if(1==result.status){if(result.data.status==statusMsg.Success){msg="亲，小牛帮美车师已接收到您的投诉，他将会在第一时间给您回电，服务不周，还请多多谅解。";var arrButton=["确定"];openDialog(msg,"",arrButton,0,function(){$scope.order.status=8,$scope.$apply($scope.order)})}}else alertWarning(result.data.message)}),5==status){var arrButton=["确定","取消"];openDialog("当前余额"+$rootScope.rootAct.balance+"元","使用余额支付",arrButton,0,function(r){r||httpRequest.PUT(dataStringify("/order/status/update_v2",data,!0),data,{"Content-Type":"application/json"},!0).then(function(result){if(1==result.status){if(result.data.status==statusMsg.Success){$scope.order.status=5,$scope.$apply($scope.order);var rootAct={user_id:$rootScope.user.id};httpRequest.Get(dataStringify("/user/details/get_v2",rootAct),!1,{}).then(function(result){debugAlert(angular.toJson(result)),result.status==statusMsg.Success?($rootScope.rootAct.balance=result.user.balance,$scope.$apply($rootScope.rootAct)):alertWarning(result.msg)})}}else alertWarning(result.data.message)})})}if(6==status){var arrButton=["取消","确定"];openDialog("您确定要取消该订单吗？","",arrButton,null,function(r){r&&httpRequest.PUT(dataStringify("/order/status/update_v2",data,!0),data,{"Content-Type":"application/json"},!0).then(function(result){1==result.status?result.data.status==statusMsg.Success&&($scope.order.status=6,$scope.$apply($scope.order),$location.path("/"),$scope.$apply($location)):alertWarning(result.data.message)})})}}}),app.controller("servicesController",function($rootScope,dataStringify,$scope,$location,signSha1,$routeParams,httpRequest){setDocumentTitle(),$rootScope.leftbar="fa-angle-left",$(".app-body").css("padding-top","50px"),$scope.selectedService=[],$scope.totalAmout=0;for(var order=getOrder()||{},arr=order.content||[],s=[],i=0;i<arr.length;i++)s.push(arr[i].id);$scope.oldServices=s,$scope.totalAmout=order.totalAmout,$scope.goToServiceDetail=function(url,name){$location.path("/service").search({url:url,name:name})};var localCity=new BMap.LocalCity;localCity.get(function(e){var city_code=e.code;$rootScope.currentCity&&$rootScope.currentCity.city&&$rootScope.currentCity.city!=e.name&&(city_code=224);var order=getOrder()||{},data={city_code:city_code,user_id:$rootScope.user.id,car_type:order.car?order.car.type:1};httpRequest.Get(dataStringify("/services/get_v2",data),!0,{}).then(function(result){if(result&&result.status==statusMsg.Success){$scope.services=result.services;for(var i=0;i<$scope.services.length;i++)for(var j=0;j<$scope.services[i].children.length;j++)"1"==$scope.services[i].children[j].is_must}})}),$(".scrollable-content").delegate(".col-xs-2.choice-option","click",function(){var $fa=$(this).find(".fa"),isRadio=$(this).parent().parent().parent().find(".service-title-radio").length,isMust=$fa.hasClass("must"),isChecked=$fa.hasClass("fa-check-circle");if(isMust)return void alertWarning("该项服务为必选项目");if(isRadio){var checkedOption=$(this).parent().parent().parent().find(".fa-check-circle");checkedOption.removeClass("fa-check-circle"),checkedOption.addClass("fa-circle-thin"),checkedOption.parent().parent().removeClass("main-text2")}isChecked?($fa.addClass("fa-circle-thin"),$fa.removeClass("fa-check-circle"),$fa.parent().parent().removeClass("main-text2")):($fa.addClass("fa-check-circle"),$fa.removeClass("fa-circle-thin"),$fa.parent().parent().addClass("main-text2")),$scope.selectedService=[],$(".col-xs-2.choice-option").each(function(){var fa=$(this).find(".fa"),svs=$(this).attr("data").split("-"),isCk=fa.hasClass("fa-check-circle");isCk&&$scope.selectedService.push($scope.services[svs[0]].children[svs[1]])}),$scope.getTotalAmout()}),$scope.getTotalAmout=function(){$scope.totalAmout=0;for(var i=0;i<$scope.selectedService.length;i++)$scope.totalAmout=$scope.totalAmout+parseInt($scope.selectedService[i].price);$scope.$apply($scope.totalAmout)},$scope.save=function(){var order=getOrder();return order?(order.content=0==$scope.selectedService.length?null:$scope.selectedService,order.totalAmout=$scope.totalAmout):(order={},order.content=0==$scope.selectedService.length?null:$scope.selectedService,order.totalAmout=$scope.totalAmout),null==order.content?void alertWarning("您未选择服务项目"):(setOrder(order),void $location.path("/order"))}}),app.controller("serviceController",function($rootScope,dataStringify,$scope,$location){setDocumentTitle("小牛帮在线预约洗车"),$rootScope.leftbar="fa-angle-left",$(".app-body").css("padding-top","50px"),$scope.search=$location.search(),$rootScope.pageTitle=$scope.search.name,$("#frame").attr("src",$scope.search.url)}),app.controller("rechargeController",function($rootScope,$scope,dataStringify,$location,signSha1,$routeParams,httpRequest){setDocumentTitle(),$rootScope.leftbar="fa-angle-left",$(".app-body").css("padding-top","50px"),$scope.defaultAmout=parseFloat($routeParams.value)||"",$scope.recharge=function(){history.back()};var data={user_id:$rootScope.user.id};httpRequest.Get(dataStringify("/recharge/products/get",data),!1,{}).then(function(result){result&&result.status==statusMsg.Success&&($scope.coupons=result.products)});({user_id:$rootScope.user.id});$scope.account={mobile:$rootScope.user.mobile,balance:$rootScope.user?$rootScope.user.balance:"0.00"},$scope.rechargeType=1,$scope.productId=0,$scope.rechargeMethod=function(type){if($scope.rechargeType=type,2==type){for(var i=0;i<$scope.coupons.length;i++)$scope.coupons[i].class="";$scope.coupons[0].class="active",$scope.rechargeAmout=$scope.coupons[0].amount,$scope.productId=$scope.coupons[0].id
}else{for(var i=0;i<$scope.coupons.length;i++)$scope.coupons[i].class="";$scope.productId=0}},$scope.chooseCoupon=function(id,index){for(var i=0;i<$scope.coupons.length;i++)$scope.coupons[i].class="";$scope.rechargeType=2,$scope.coupons[index].class="active",$scope.rechargeAmout=$scope.coupons[index].amount,$scope.productId=id},$scope.payType=4,$scope.choosePayMetod=function(type){if($scope.payType=type,3==type){var arrButton=["取消","确定"];openPrompt("<input type='text' placeholder='请输入充值卡密码' style='width:100%;border: 1px solid #eee;'/>","充值卡充值",arrButton,function(r,data){if(r){var dataCard={user_id:$rootScope.user.id,card_no:data[0]};httpRequest.POST(dataStringify("/card/purchase",dataCard,!0),dataCard,{"Content-Type":"application/json"},!0).then(function(result){1==result.status?result.data.status==statusMsg.Success&&alertExt("充值卡充值成功！",function(){history.back()}):alertWarning(result.data.message)})}})}},$scope.recharge=function(){var amount=0;if(1==$scope.rechargeType){if(!$scope.defaultAmout)return void alertWarning("充值金额只能是大于0的数字");var re=/^[0-9]+.?[0-9]*$/;if(!re.test($scope.defaultAmout))return void alertWarning("充值金额只能是数字");amount=$scope.defaultAmout}else amount=$scope.rechargeAmout;if(3===$scope.payType){var arrButton=["取消","确定"];openPrompt("<input type='text' placeholder='请输入充值卡密码' style='width:100%;border: 1px solid #eee;'/>","充值卡充值",arrButton,function(r,data){if(r){var dataCard={user_id:$rootScope.user.id,card_no:data[0]};httpRequest.POST(dataStringify("/card/purchase",dataCard,!0),dataCard,{"Content-Type":"application/json"},!0).then(function(result){1==result.status?result.data.status==statusMsg.Success&&alertExt("充值卡充值成功！",function(){history.back()}):alertWarning(result.data.message)})}})}1===$scope.payType&&(window.location="/ebank/pay/?amount="+amount+"&no="+(new Date).getTime()+"&rechargeType="+$scope.payType+"&uid="+$rootScope.user.id+"&openid="+$rootScope.user.openid+"&productId="+$scope.productId),2===$scope.payType&&(window.location="/ebank/pay/?amount="+amount+"&no="+(new Date).getTime()+"&rechargeType="+$scope.payType+"&uid="+$rootScope.user.id+"&openid="+$rootScope.user.openid+"&productId="+$scope.productId),4===$scope.payType&&(window.location="/ebank/pay/?amount="+amount+"&no="+(new Date).getTime()+"&rechargeType="+$scope.payType+"&uid="+$rootScope.user.id+"&openid="+$rootScope.user.openid+"&productId="+$scope.productId)},$scope.checkAmountFormat=function(e){$(e.target).val();8!=e.keyCode&&46!=e.keyCode&&13!=e.keyCode&&190!=e.keyCode&&(e.keyCode<48||e.keyCode>57)&&(e.returnValue=!1)}}),app.controller("myCarsController",function($rootScope,dataStringify,$scope,$location,signSha1,$routeParams,httpRequest){setDocumentTitle(),$rootScope.leftbar="fa-angle-left",$(".app-body").css("padding-top","0px"),$scope.addCar=function(){removeCar(),$location.path("/car")},$scope.goToCar=function(car){removeCar();var c={};c.city=car.car_no.substr(0,1),c.cityCode=car.car_no.substr(1,1),c.no=car.car_no.substr(2),c.id=car.id,c.color=car.color,c.brand=car,setCar(c),$location.path("/car")};var data={user_id:$rootScope.user.id,direction:1};httpRequest.Get(dataStringify("/cars/get",data),!0,{}).then(function(result){if(result&&result.status==statusMsg.Success){$scope.cars=result.cars;var order=getOrder()||{};$scope.car=order.car||$scope.cars[0]}}),$scope.save=function(){var order=getOrder()||{};order.car&&order.car.id&&order.car.id==$scope.car.id||(order.content=null,order.totalAmout=0),order.car=$scope.car,setOrder(order),$location.path("/order/"+getCleaner().id)},$(".scrollable-content").delegate(".col-xs-2.choice-option","click",function(){var $fa=$(this).find(".fa"),index=$fa.attr("data"),isChecked=$fa.hasClass("fa-check-circle"),ckNum=$(".scrollable-content .fa-check-circle").length;$(".col-xs-2.choice-option").each(function(){if(ckNum>0){var fa=$(this).find(".fa");fa.addClass("fa-circle-thin"),fa.removeClass("fa-check-circle")}}),isChecked&&1!=ckNum?($fa.addClass("fa-circle-thin"),$fa.removeClass("fa-check-circle")):($fa.addClass("fa-check-circle"),$fa.removeClass("fa-circle-thin")),$scope.car=$scope.cars[index]}),$scope.swipeLeft=function(e){var elm=e.currentTarget;$(elm).removeClass("swipe-right"),$(elm).addClass("swipe-left")},$scope.swipeRight=function(e){var elm=e.currentTarget;$(elm).removeClass("swipe-left"),$(elm).addClass("swipe-right")},$scope.deleteCar=function(id){var data={user_id:$rootScope.user.id,car_id:id};httpRequest.DELETE(dataStringify("/car/delete",data),data,{"Content-Type":"application/json"},!0).then(function(result){if("OK"==result.status){var rdata={user_id:$rootScope.user.id,direction:1};httpRequest.Get(dataStringify("/cars/get",rdata),!0,{}).then(function(result){if(result&&result.status==statusMsg.Success){$scope.cars=result.cars;var order=getOrder()||{};$scope.car=order.car||$scope.cars[0],alertWarning("删除成功！")}})}else alertWarning(result.data.message)})}}),app.controller("carController",function($rootScope,dataStringify,$scope,$location,signSha1,$routeParams,httpRequest){setDocumentTitle(),$rootScope.leftbar="fa-angle-left",$(".app-body").css("padding-top","0px"),$scope.car=getCar()||{},$scope.carNo=$scope.car.no||"",$scope.selectBrand=function(){$scope.setCar(),$location.path("/carBrand")},$scope.goToColor=function(){$("#demo").mobiscroll("show")},$("#demo").mobiscroll().select({theme:"android-ics light",display:"bottom",minWidth:200,width:300,mode:"scroller",setText:"确认",cancelText:"取消",onSelect:function(){var selectObj=$("#demo").mobiscroll("getInst");$scope.car=getCar()||{},$scope.car.color=selectObj.getValue(),$scope.$apply($scope.car.color);var c=getCar()||{};c.color=$scope.car.color,setCar(c)}}),$scope.setCar=function(){var car=getCar()||{};car.no=$scope.carNo,setCar(car)},$scope.saveCar=function(){$scope.setCar();var car=getCar()||{};if(car.city=car.city||"苏",car.cityCode=car.cityCode||"E",!car.no||car.no&&5!=car.no.length)return void alertWarning("请输入5位车牌号");if(!car.brand)return void alertWarning("请选择车辆型号");if(!car.brand.mode&&!car.brand.name)return void alertWarning("请选择车辆型号");if(!car.color)return void alertWarning("请选择车辆颜色");var data={user_id:$rootScope.user.id,car_no:car.city+car.cityCode+car.no,brand:car.brand.brand,mode:car.brand.name||car.brand.mode,color:car.color,type:car.brand.type};car.id?(data.car_id=car.id,httpRequest.PUT(dataStringify("/car/update",data,!0),data,{"Content-Type":"application/json"},!0).then(function(result){1==result.status?result.data.status==statusMsg.Success&&($scope.newcar=result.data.car,$scope.car.id=result.data.car.id,setCar($scope.car),alertExt("修改成功！",function(){$location.path("myCars"),$scope.$apply($location)})):alertWarning(result.data.message)})):httpRequest.POST(dataStringify("/car/add",data,!0),data,{"Content-Type":"application/json"},!0).then(function(result){1==result.status?result.data.status==statusMsg.Success&&($scope.newcar=result.data.car,$scope.car.id=result.data.car.id,setCar($scope.car),alertExt("添加成功！",function(){$location.path("myCars"),$scope.$apply($location)})):alertWarning(result.data.message)})},$scope.checkCarNo=function(e){var no=$(e.target).val();no&&no.length>=5&&8!=e.keyCode&&46!=e.keyCode&&(e.returnValue=!1)},$scope.upperCaseCarNo=function(){},$scope.getRegion=function(){$location.path("/carCity")},$scope.getRegionLetter=function(){$location.path("/carCity/1")}}),app.controller("carBrandController",function($rootScope,dataStringify,$scope,$filter,$anchorScroll,anchorScroll,$location,signSha1,$routeParams,httpRequest){setDocumentTitle(),$rootScope.leftbar="fa-angle-left",$(".app-body").css("padding-top","0px"),$scope.gotoAnchor=function(e){var t=$(e.target).attr("target");anchorScroll.toView("#"+t,!0,50)},$scope.gotoSubBrand=function(sId){$location.path("/carSubBrand/"+sId)};var data={user_id:$rootScope.user.id};httpRequest.Get(dataStringify("/car/brand/get",data),!0,{}).then(function(result){result&&result.status==statusMsg.Success&&($scope.carBrands=result.car_brands)})}),app.controller("carSubBrandController",function($rootScope,dataStringify,$scope,$location,signSha1,$routeParams,httpRequest){setDocumentTitle();var brandId=$routeParams.id||0;$rootScope.leftbar="fa-angle-left",$(".app-body").css("padding-top","0px");var data={user_id:$rootScope.user.id,brand_id:brandId};httpRequest.Get(dataStringify("/car/modes/get",data),!0,{}).then(function(result){result&&result.status==statusMsg.Success&&($scope.subBrands=result.car_modes)}),$scope.gotoOrder=function(sId,index,parent){var c=$scope.subBrands[parent].list[index];c.brandId=brandId;var car=getCar()||{};car.brand=c,setCar(car),$location.path("/car")}}),app.controller("carCityController",function($rootScope,dataStringify,$scope,$location,signSha1,$routeParams){setDocumentTitle(),$rootScope.leftbar="fa-angle-left",$(".app-body").css("padding-top","0px"),$scope.type=$routeParams.type?!0:!1,$(".scrollable-content").delegate(".car-city","click",function(){$(this).addClass("car-city-active");var car=getCar()||{};$scope.type?car.cityCode=$(this).text():car.city=$(this).text(),setCar(car),$location.path("/car"),$scope.$apply($location)})}),app.controller("myOrdersController",function($rootScope,dataStringify,$scope,$location,signSha1,$routeParams,httpRequest){setDocumentTitle(),$rootScope.currentTab=$rootScope.currentTab?$rootScope.currentTab:1,$scope.setCurrentTab=function(c){$rootScope.currentTab=c},$rootScope.leftbar="fa-angle-left",$(".app-body").css("padding-top","50px");var data={user_id:$rootScope.user.id,type:1,direction:1,reference_id:1};httpRequest.Get(dataStringify("/order/my",data),{}).then(function(result){result&&result.status==statusMsg.Success?(debugAlert(angular.toJson(result)),$scope.currentOrders=result.orders):alertWarning(result.message)});var data={user_id:$rootScope.user.id,type:2,direction:1,reference_id:1};httpRequest.Get(dataStringify("/order/my",data),{}).then(function(result){result&&result.status==statusMsg.Success?(debugAlert(angular.toJson(result)),$scope.orders=result.orders):alertWarning(result.message)}),$scope.goToOrderPage=function(id){$location.path("/payment/"+id)}}),app.controller("myCouponsController",function($rootScope,dataStringify,$scope,$location,signSha1,$routeParams,httpRequest){setDocumentTitle(),$rootScope.leftbar="fa-angle-left",$(".app-body").css("padding-top","0");var data={user_id:$rootScope.user.id};httpRequest.Get(dataStringify("/coupon/my",data),{}).then(function(result){result&&result.status==statusMsg.Success?(debugAlert(angular.toJson(result)),$scope.coupons=result.coupons):alertWarning(result.message)}),$scope.addCoupon=function(data,callback){httpRequest.POST(dataStringify("/coupon/add",data,!0),data,{"Content-Type":"application/json"},!0).then(function(result){1==result.status?result.data.status==statusMsg.Success&&alertExt("添加优惠券成功！",function(){callback&&callback(result.data.coupon)}):alertWarning(result.data.message)})},$scope.addNewCoupon=function(){if(!$scope.couponNo)return alertWarning("请输入优惠券密码"),!1;var data={user_id:$rootScope.user.id,coupon_serial_no:$scope.couponNo},callback=function(){$rootScope.couponPage=!1,$rootScope.isNoBack=!1;var data={user_id:$rootScope.user.id};httpRequest.Get(dataStringify("/coupon/my",data),{}).then(function(result){result&&result.status==statusMsg.Success?(debugAlert(angular.toJson(result)),$scope.coupons=result.coupons):alertWarning(result.message)})};$scope.addCoupon(data,callback)},$scope.navSave=function(){$scope.couponNo="",$rootScope.couponPage=!0,$rootScope.isNoBack=!0},$scope.setCoupon=function(coupon){if(2==coupon.provider_id){var arrButton=["取消","前往下载"];return void openDialog("该优惠券只能在小牛帮APP内使用，请下载小牛帮APP","",arrButton,null,function(r){r&&(window.location.href="http://d.xiaoniubang.com/")})}}}),app.controller("accountDetailController",function($rootScope,dataStringify,$scope,$location,signSha1,$routeParams,httpRequest){setDocumentTitle(),$rootScope.leftbar="fa-angle-left",$(".app-body").css("padding-top","50px");var data={user_id:$rootScope.user.id,type:1,direction:1,reference_id:1};httpRequest.Get(dataStringify("/transactions/get",data),{}).then(function(result){result&&result.status==statusMsg.Success?(debugAlert(angular.toJson(result)),$scope.currentOrders=result.transactions):alertWarning(result.message)}),$scope.getPayType=function(t){return 1==t?"余额支付":2==t?"e币(积分)":3==t?"红包":"余额支付"},$scope.getRechargeType=function(t){return 1==t?"银联":2==t?"支付宝(移动)":3==t?"充值卡充值":4==t?"支付宝(wap)":5==t?"建行网银":6==t?"微信支付":7==t?"财付通":8==t?"系统充值":9==t?"苏州银行":"充值卡充值"};var data={user_id:$rootScope.user.id,type:2,direction:1,reference_id:1};httpRequest.Get(dataStringify("/transactions/get",data),{}).then(function(result){result&&result.status==statusMsg.Success?(debugAlert(angular.toJson(result)),$scope.orders=result.transactions):alertWarning(result.message)})}),app.controller("oauth2Controller",function($rootScope,$scope,httpRequest,dataStringify,$location,$window){setDocumentTitle("微信登录授权"),$rootScope.pageTitle="微信登录授权";var host=$location.absUrl().split("oauth2.php")[0],code=getQueryStringByName("code"),state=getQueryStringByName("state");$scope.isLogin=!1;var url="http://m.xiaoniubang.com/api/getopenid.php?code="+code;$.get(url,function(r){if(r&&r.openid){var url2="http://m.xiaoniubang.com/api/getuser.php?token="+r.access_token+"&openid="+r.openid;alertWarning("授权成功，正在获取用户信息..."),$.get(url2,function(r2){r2&&r2.openid?alertExt("获取用户信息成功",function(){var data={weixin_open_id:r2.openid},bindPhone=function(){setDocumentTitle("绑定手机号码"),$rootScope.pageTitle="微信登录授权",$scope.isLogin=!0,$scope.$apply($rootScope.pageTitle),$scope.$apply($scope.isLogin),$("#btnSetPhone").bind("click",function(){var mobile=$("#mobile").val();if(!mobile)return void alertWarning("请输入手机号码");if(11!=mobile.length)return void alertWarning("请输入11位手机号码");var data={mobile:mobile,weixin_open_id:r2.openid};httpRequest.POST(dataStringify("/user/wechat/binding",data,!0),data,{"Content-Type":"application/json"},!0).then(function(result){1==result.status?result.data.status==statusMsg.Success&&alertExt("绑定手机号成功！",function(){setToken(result.data.user,r2),$window.location=host+"#/"+state}):alertWarning(result.data.message)})})};httpRequest.Get(dataStringify("/user/wechat/details",data),{}).then(function(result){debugAlert(angular.toJson(result)),result&&result.status==statusMsg.Success&&(result.user&&result.user.mobile?(setToken(result.user,r2),$window.location=host+"#/"+state):bindPhone()),result&&"193020"==result.status&&bindPhone()})}):alertWarning(r.errmsg)})}else alertWarning(r.errmsg)})}),app.controller("homeController",function($rootScope,$scope,$location){function translatePoint(position){var currentLat=position.coords.latitude,currentLon=position.coords.longitude,gpsPoint=new BMap.Point(currentLon,currentLat);bm.centerAndZoom(gpsPoint,15),bm.addControl(new BMap.NavigationControl),setTimeout(function(){BMap.Convertor.translate(gpsPoint,0,initMap)},0)}function initMap(point){var marker=new BMap.Marker(point);bm.addOverlay(marker);var label=new BMap.Label("美车师",{offset:new BMap.Size(20,-10)});marker.setLabel(label),bm.setCenter(point)}setDocumentTitle(),$rootScope.leftbar="fa-bars",$(".app-body").css("padding-top","50px"),$("#allmap").height($(".home-page").height()-$(".nav-bar-bottom").height());var bm=new BMap.Map("allmap");getLocation(function(data,isSuccess){isSuccess?translatePoint(data):alertWarning("请先开启您的定位服务再试")}),$scope.order=function(){$location.path("/teachers")}});